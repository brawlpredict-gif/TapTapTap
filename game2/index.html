<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width,
initial-scale=1.0,
maximum-scale=1.0,
user-scalable=no,
viewport-fit=cover">

<title>Tomato Jump</title>

<style>
*{
margin:0;
padding:0;
box-sizing:border-box;

/* –ü–û–õ–ù–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –í–´–î–ï–õ–ï–ù–ò–Ø */
user-select:none !important;
-webkit-user-select:none !important;
-webkit-touch-callout:none !important;
-webkit-tap-highlight-color:transparent !important;
}

html,body{
overflow:hidden;
background:#87CEEB;
touch-action:none;
font-family:Arial;
}

canvas{
display:block;
}

#score{
position:fixed;
top:15px;
left:15px;
font-size:22px;
color:white;
font-weight:bold;
z-index:10;
pointer-events:none;
}

#controls{
position:fixed;
bottom:20px;
left:0;
width:100%;
display:flex;
justify-content:space-between;
padding:0 30px;
z-index:10;
}

.btn{
width:90px;
height:90px;
border-radius:50%;
border:none;
background:rgba(0,0,0,0.35);
color:white;
font-size:36px;
outline:none;
}

.btn:active{
background:rgba(0,0,0,0.6);
}
</style>
</head>

<body>

<div id="score">0</div>
<canvas id="game"></canvas>

<div id="controls">
<button class="btn" id="left">‚Üê</button>
<button class="btn" id="right">‚Üí</button>
</div>

<script>

/* –î–û–ü. –ë–õ–û–ö–ò–†–û–í–ö–ò */
document.addEventListener("selectstart", e => e.preventDefault(), {passive:false})
document.addEventListener("contextmenu", e => e.preventDefault())
document.addEventListener("dragstart", e => e.preventDefault())

const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")

function resize(){
canvas.width = window.innerWidth
canvas.height = window.innerHeight
}
resize()
window.addEventListener("resize", resize)

const imgFall = new Image()
imgFall.src="player_fall.png"

const imgJump = new Image()
imgJump.src="player_jump.png"

let currentImg = imgFall

// –§–ò–ó–ò–ö–ê (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
const GRAVITY = 0.23
const JUMP_FORCE = -7.2
const MOVE_SPEED = 4.5
const MAX_FALL_SPEED = 10
const MAX_PLATFORM_GAP = 130   // –º–∞–∫—Å–∏–º—É–º –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø—Ä—ã–∂–∫–∞

let player
let platforms = []
let score = 0
let difficulty = 1
let gameRunning = true

function createPlayer(){
player = {
width:60,
height:75,
x:canvas.width/2-30,
y:canvas.height-200,
vx:0,
vy:0
}
}

function createPlatforms(){

platforms = []
let count = 12
let gap = canvas.height / count

let lastY = canvas.height

for(let i=0;i<count;i++){

let y = lastY - gap
let x = Math.random()*(canvas.width-90)

platforms.push({
x:x,
y:y,
width:90,
height:18,
type:"normal",
vx:0,
broken:false,
hasSpring:false
})

lastY = y
}

}

function resetGame(){
score=0
difficulty=1
createPlayer()
createPlatforms()
gameRunning=true
}

let left=false
let right=false

document.getElementById("left").ontouchstart=e=>{e.preventDefault();left=true}
document.getElementById("left").ontouchend=e=>{e.preventDefault();left=false}
document.getElementById("right").ontouchstart=e=>{e.preventDefault();right=true}
document.getElementById("right").ontouchend=e=>{e.preventDefault();right=false}

function update(){

if(!gameRunning) return

if(left) player.vx=-MOVE_SPEED
else if(right) player.vx=MOVE_SPEED
else player.vx=0

player.x+=player.vx

if(player.x<-player.width) player.x=canvas.width
if(player.x>canvas.width) player.x=-player.width

player.vy+=GRAVITY
if(player.vy>MAX_FALL_SPEED) player.vy=MAX_FALL_SPEED
player.y+=player.vy

currentImg = player.vy < 0 ? imgJump : imgFall

// —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
if(player.vy>0){
for(let p of platforms){

if(p.broken) continue

if(
player.x+player.width>p.x &&
player.x<p.x+p.width &&
player.y+player.height>p.y &&
player.y+player.height<p.y+p.height
){

if(p.type==="break"){
p.broken=true
}else{
if(p.hasSpring){
player.vy = JUMP_FORCE*1.5
}else{
player.vy = JUMP_FORCE
}
}
}
}
}

// –¥–≤–∏–∂–µ–Ω–∏–µ –º–∏—Ä–∞
if(player.y<canvas.height*0.4){

let diff=canvas.height*0.4-player.y
player.y=canvas.height*0.4

for(let p of platforms){
p.y+=diff
}

score+=Math.floor(diff)
difficulty=1+score/5000
}

// —Ä–µ—Å–ø–∞–≤–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º (–ë–ï–ó –ù–ï–í–û–ó–ú–û–ñ–ù–´–• –ü–†–´–ñ–ö–û–í)
for(let i=0;i<platforms.length;i++){

let p=platforms[i]

if(p.y>canvas.height){

// –Ω–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é –≤–µ—Ä—Ö–Ω—é—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
let highest = platforms.reduce((a,b)=>a.y<b.y?a:b)

p.y = highest.y - (90 + Math.random()*40) // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç–∏–∂–∏–º—ã–π gap
p.x = Math.random()*(canvas.width-p.width)

// –±–∞–ª–∞–Ω—Å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
let breakChance = score>2000 ? Math.min(0.25,score/8000) : 0
let moveChance = score>1500 ? Math.min(0.2,score/8000) : 0
let springChance = Math.min(0.15,score/9000)

let r=Math.random()

if(r<breakChance){
p.type="break"
p.hasSpring=false   // üî¥ –Ω–µ–ª—å–∑—è –ø—Ä—É–∂–∏–Ω—É –Ω–∞ –∫—Ä–∞—Å–Ω–æ–π
}
else if(r<breakChance+moveChance){
p.type="move"
p.vx=(Math.random()<0.5?-1:1)*(1+difficulty*0.2)
p.hasSpring=false
}
else{
p.type="normal"
p.hasSpring=(Math.random()<springChance)
}

p.broken=false
}
}

if(player.y>canvas.height){
gameRunning=false
setTimeout(resetGame,500)
}

}

function draw(){

ctx.clearRect(0,0,canvas.width,canvas.height)

ctx.drawImage(currentImg,player.x,player.y,player.width,player.height)

for(let p of platforms){

if(p.broken) continue

if(p.type==="break") ctx.fillStyle="#e74c3c"
else if(p.type==="move") ctx.fillStyle="#f1c40f"
else ctx.fillStyle="#2ecc71"

ctx.fillRect(p.x,p.y,p.width,p.height)

if(p.hasSpring){
ctx.fillStyle="white"
ctx.fillRect(p.x+p.width/2-5,p.y-10,10,10)
}
}

document.getElementById("score").innerText=score
}

function loop(){
update()
draw()
requestAnimationFrame(loop)
}

resetGame()
loop()

</script>
</body>
</html>
