<!DOCTYPE html>
<html lang="ru">
<head>

<meta charset="UTF-8">

<meta name="viewport"
content="
width=device-width,
initial-scale=1.0,
maximum-scale=1.0,
user-scalable=no,
viewport-fit=cover
">

<title>Tomato Jump</title>

<style>

html,body{
margin:0;
padding:0;
overflow:hidden;
background:#87CEEB;
touch-action:none;
font-family:Arial;
}

/* CANVAS */

canvas{
display:block;
}

/* SCORE */

#score{
position:fixed;
top:15px;
left:15px;
font-size:22px;
color:white;
font-weight:bold;
z-index:10;
}

/* CONTROLS */

#controls{

position:fixed;
bottom:20px;
left:0;
width:100%;

display:flex;
justify-content:space-between;

padding:0 30px;

box-sizing:border-box;

z-index:10;
}

.btn{

width:90px;
height:90px;

border-radius:50%;

border:none;

background:rgba(0,0,0,0.35);

color:white;

font-size:36px;

}

.btn:active{
background:rgba(0,0,0,0.6);
}

</style>

</head>
<body>

<div id="score">0</div>

<canvas id="game"></canvas>

<div id="controls">

<button class="btn" id="left">←</button>
<button class="btn" id="right">→</button>

</div>

<audio id="music" loop>
<source src="music.mp3">
</audio>

<script>

// CANVAS

const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")

function resize(){

canvas.width = window.innerWidth
canvas.height = window.innerHeight

}

resize()

window.addEventListener("resize", resize)

// IMAGES

const imgFall = new Image()
imgFall.src="player_fall.png"

const imgJump = new Image()
imgJump.src="player_jump.png"

let currentImg = imgFall

// PLAYER

let player

// GAME VARS

let gravity = 0.5

let platforms = []

let score = 0

let gameRunning = true

// CREATE PLAYER

function createPlayer(){

player = {

x: canvas.width/2 - 35,
y: canvas.height - 200,

width:70,
height:70,

vx:0,
vy:-15

}

}

// CREATE PLATFORMS

function createPlatforms(){

platforms = []

let count = 18 // было 12, теперь больше

let spacing = canvas.height / count

for(let i=0;i<count;i++){

let x = Math.random()*(canvas.width-100)
let y = i*spacing

platforms.push({

x:x,
y:y,

width:100,
height:20

})

}

// ВАЖНО: гарантированная платформа под игроком

platforms.push({

x: player.x,
y: player.y + 80,

width:120,
height:20

})

}

// RESET GAME

function resetGame(){

score = 0

createPlayer()

createPlatforms()

gameRunning = true

}

// CONTROLS

let left=false
let right=false

const leftBtn = document.getElementById("left")
const rightBtn = document.getElementById("right")

leftBtn.ontouchstart=()=>left=true
leftBtn.ontouchend=()=>left=false

rightBtn.ontouchstart=()=>right=true
rightBtn.ontouchend=()=>right=false

// keyboard support

document.addEventListener("keydown", e=>{

if(e.key=="ArrowLeft") left=true
if(e.key=="ArrowRight") right=true

})

document.addEventListener("keyup", e=>{

if(e.key=="ArrowLeft") left=false
if(e.key=="ArrowRight") right=false

})

// MUSIC START

document.body.addEventListener("touchstart", ()=>{

document.getElementById("music").play()

}, {once:true})

// UPDATE

function update(){

if(!gameRunning) return

// MOVE

if(left) player.vx = -6
else if(right) player.vx = 6
else player.vx = 0

player.x += player.vx

// wrap

if(player.x < -player.width)
player.x = canvas.width

if(player.x > canvas.width)
player.x = -player.width

// gravity

player.vy += gravity
player.y += player.vy

// default image

currentImg = imgFall

// collision

platforms.forEach(p=>{

if(

player.vy > 0 &&
player.x + player.width > p.x &&
player.x < p.x + p.width &&
player.y + player.height > p.y &&
player.y + player.height < p.y + p.height + 10

){

player.vy = -15

currentImg = imgJump

score += 10

}

})

// move world

if(player.y < canvas.height/2){

let diff = canvas.height/2 - player.y

player.y = canvas.height/2

platforms.forEach(p=>{

p.y += diff

if(p.y > canvas.height){

p.y = -20

// ограничиваем максимальную дистанцию прыжка
let maxJumpDistance = 180

let minX = player.x - maxJumpDistance
let maxX = player.x + maxJumpDistance

if(minX < 0) minX = 0
if(maxX > canvas.width-100) maxX = canvas.width-100

p.x = minX + Math.random()*(maxX-minX)

}

})

}

// FALL = GAME OVER

if(player.y > canvas.height){

gameRunning = false

setTimeout(resetGame, 500)

}

}

// DRAW

function draw(){

ctx.clearRect(0,0,canvas.width,canvas.height)

// player

ctx.drawImage(
currentImg,
player.x,
player.y,
player.width,
player.height
)

// platforms

ctx.fillStyle="#2ecc71"

platforms.forEach(p=>{

ctx.fillRect(
p.x,
p.y,
p.width,
p.height
)

})

// score

document.getElementById("score").innerText = score

}

// LOOP

function loop(){

update()
draw()

requestAnimationFrame(loop)

}

// START

resetGame()

loop()

</script>

</body>
</html>